<!DOCTYPE html>
<html>
<head>
  <title>Live Audio Match</title>
</head>
<body>
  <button id="listenBtn">ðŸŽ¤ Listen</button>
  <p id="result"></p>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    const btn = document.getElementById("listenBtn");

    btn.addEventListener("click", async () => {
      console.log("started rec")
      if (mediaRecorder?.state === "recording") return;
      btn.disabled = true;
      audioChunks = [];

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const track = stream.getAudioTracks()[0];
      console.log("Using device:", track.label);
      // Prefer OGG, fallback to WebM if not supported
      let options = { mimeType: "audio/ogg;codecs=opus" };
      if (!MediaRecorder.isTypeSupported(options.mimeType)) {
        options = { mimeType: "audio/webm;codecs=opus" };
      }

      mediaRecorder = new MediaRecorder(stream, options);

      mediaRecorder.ondataavailable = event => {
        if (event.data.size > 0) {
          audioChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = async () => {
        stream.getTracks().forEach(t => t.stop());

        const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
        console.log("Blob size:", audioBlob.size); // Debugging
     
        const extension = mediaRecorder.mimeType.includes("ogg") ? "ogg" : "webm";
        const formData = new FormData();
        formData.append("file", audioBlob, "recording." + extension);
        console.log("formdata",formData.size)
        const response = await fetch("/process_audio", {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        document.getElementById("result").innerText = "Match result: " + data.result;
        btn.disabled = false;
      };

      // Request chunks every second to avoid empty blobs
      mediaRecorder.start(1000);

      setTimeout(() => {
        if (mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }
      }, 20000);
    });
  </script>
</body>
</html>